{
  "hash": "3b1ae4fe7f9d35443378669279050bb5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Translate using Google Translate\"\ndescription: \"Translate using Google Cloud Platform (GCP) Translate API\"\nauthor: \n  - name: Purushottam Mohanty\ndate: \"2022-01-18\"\n#categories: [python]\n---\n\n\n\n\n      \n$~$\n\nThis is a short write-up for beginners who want to use the Google Cloud Platform (GCP) Translation Client API to translate one or multiple variables from a dataset. \n\nThe [GCP Translate API](\"https://cloud.google.com/translate\") can be used for quick and effective translation. The Basic API is free to use upto 500,000 characters per month and thereafter carries a cost of 20 USD for each 1 million character. There are also advanced, media and auto ML translate APIs which is beyond the scope of the article. Note that if you translate a string or text without specifying the source language, the characters are only counted once towards the quota. There's no additional cost of detecting the language. However, explicitly detecting source language count towards the quota. \n\nGoogle provides an official translation API for Python and that is what the following blog uses. First of all we are going to setup a GCP account and create our credentials.   \n\n1. Go to [Google Cloud](\"https://cloud.google.com\") and sign in using your Google Account.  \n2. Once you are in your dashboard, go to the top bar and create a new project.      \n3. Then click billing and then setup billing for the project. You would ideally need your credit card to set it up. (Don't worry you will not be charged for any request beyond your quota unless to move to a paid account. The APIs will provide an error if you exceed your quota and will not proceed further without converting to a paid account.) Additionally, at the time of writing this post, Google provided a joining credit of 300 USD which can be used.         \n4. Once billing has been setup, select the \"APIs and Services\" option in the right side menu and search for \"Translate API\" and click \"Enable\".  \n5. Select \"IAM and Admin\" and then \"Service Account\".       \n6. Create a Service Account and then create keys. (The keys automatically get downloaded as a json file. You cannot download the keys again so keep it somewhere safe in your local machine.)       \n    \nThen we shall download the required packages directly from terminal in case you haven't downloaded these previously. Simply run these code in terminal. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n$ python3 -m pip install pandas\n$ python3 -m pip install numpy\n$ python3 -m pip install google-cloud-translate\n```\n:::\n\n\n\n### Import Necessary Packages\nNow run the following chunk directly in Python to import the libraries. \n\n\n::: {.cell}\n\n```{.python .cell-code}\nimport pandas as pd\nimport numpy as np\nimport json\nfrom google.cloud import translate\n```\n:::\n\n\n\n\n### Setup GCP Client Credentials\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# set service account credentials\nclient_credentials = json.load(open(\"FULL_PATH_TO_KEY.json\"))\n# set project id and build client\nproject_id = client_credentials['project_id']\nassert project_id\nparent = f\"projects/{project_id}\"\nclient = translate.TranslationServiceClient()\n```\n:::\n\n\n\n### Getting all Language Codes\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# Get all languages\nresponse = client.get_supported_languages(parent = parent, display_language_code = \"en\")\nlanguages = response.languages\n\nprint(f\" Languages: {len(languages)} \".center(60, \"-\"))\nfor language in languages:\n    print(f\"{language.language_code}\\t{language.display_name}\")\n```\n:::\n\n\n\n### Translate Example\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# GCP translate\nsample_text = [\"Bonjour\", \"Oui\"]\ntarget_language_code = \"en\"\n\nresponse = client.translate_text(\n    contents = sample_text,\n    target_language_code = target_language_code,\n    parent = parent,\n)\n\nfor translation in response.translations:\n    print(translation.translated_text)\n```\n:::\n\n\n\n\n### Import Dataset\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# load dataset as pandas dataframe\ninput_df = pd.read_stata(\"PATH_TO_DATASET.dta\")\n\n# tidy dataset (remove line separators from data)\ninput_df = input_df.replace(r'\\r', '', regex=True)\ninput_df = input_df.replace(r'\\n', '', regex=True)\n\n# GCP translate API doesn't support empty strings (to avoid errors)\n# identify empty rows in variable\ninput_df['french_var_empty'] = np.where(input_df['french_var'] == \"\", 1, 0) \n# set a fake string to avoid errors\ninput_df['french_var'] = np.where(input_df['french_var'] == \"\", \"1\", input_df['french_var']) \n```\n:::\n\n\n\n### Translate from Dataset\nThe GCP translate API doesn't accept large chunks of text hence we divide the data into batches of 200 rows and translate within a loop until we exhaust the entire length of the dataframe.\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# set empty translated list\ntranslated_output_list = []\n\n# translate in chunks\nx1 = 0\nx2 = 200\n\nwhile x1 < len(input_df):\n    input_text = input_df[x1:x2]['french_var']\n    target_language_code = \"en\"\n    # translate \n    response = client.translate_text(\n        contents = input_text,\n        target_language_code = target_language_code,\n        parent = parent,\n    )\n    # append to list\n    for n in range(0,len(response.translations)):\n        translated_output = response.translations[n].translated_text\n        translated_output_list.append(translated_output)\n    # update counter\n    x1 = x1 + 200\n    x2 = x1 + 200\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}